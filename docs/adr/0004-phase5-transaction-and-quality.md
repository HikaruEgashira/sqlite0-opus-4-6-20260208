# ADR-0004: Phase 5 方針 — トランザクション + 品質基盤強化

## ステータス

採用

## コンテキスト

Phase 4（DISTINCT, HAVING, ALTER TABLE, CREATE INDEX, サブクエリ）が完了し、次のフェーズの方針を決定する必要がある。候補は (A) B-Treeストレージ, (B) トランザクション, (C) 品質保証強化の3つである。

現在のアーキテクチャはインメモリHashMapベースであり、B-Tree導入は全レイヤーに影響する大規模変更となる。一方、品質基盤（ユニットテスト、エラーハンドリング）は Differential Testing のみに依存している。

## 決定

Phase 5 では以下の2つを並行して進める:
- **Phase 5A**: トランザクション (BEGIN/COMMIT/ROLLBACK) をインメモリスナップショット方式で実装する
- **Phase 5B**: コア実行エンジンのリファクタリングとエラーハンドリング改善を行う

B-Tree ストレージは Phase 6 に据える。

## 理由

- B-Tree 導入前に品質基盤を固めることで、大規模変更時の不具合切り分けが容易になる
- インメモリトランザクションはSQL互換性の一環として価値がある（複数文の原子性保証）
- core の select 関数は既に複雑であり、B-Tree 導入前にリファクタリングすることで保守性を確保する
- Principalの「Automated Reasoningを用いて形式的に安全性を証明」に向けた基盤整備となる

## リスクと対応

- リスク: インメモリトランザクションはストレージなしでは価値が限定的である
  - 対応（受容）: SQL構文互換性の確保として十分な価値がある。B-Tree導入時に永続化トランザクションへ拡張する
- リスク: リファクタリングで既存テストが壊れる可能性がある
  - 対応（軽減）: Differential Testing 22ケースを常にグリーンに保ちながら段階的に進める
